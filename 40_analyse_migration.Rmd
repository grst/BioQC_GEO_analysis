# Tissue Migration

```{r setup, include=FALSE}
source("lib/knitr.R")
library(BioQC)
library(rworldmap)
library(data.table)
source("lib/plots.R")
source("lib/db.R")
```


Now, detect samples we defined as contamined:
* highly siginificant BioQC scores (min score per sample >6)
* signature outside 'expected' signature that is at least 6 higher than the highest score in expected signatures. 
* (outlier in study)

We can find contamined studies with SQL only. 
To speed up things, we create a temporary table (rather a materialized view, but that's 
not available on our old postgres server) filtering for samples, where a non-expected
signature exceeds all expected signatures by a certain threshold (BioQC score > 6, aka. 'enrichment-ratio'). This table is created in `db/queries/mk-extended_bioqc_res_table2.sql`. 

We create a view `contamined_samples` that contains all contamined samples in `db/queries/get_contamined_samples.sql`. 

Second, we retrieve the information we need for the migration chart from that temporary table. 
```{r migration_chart, fig.width=8, fig.height=8} 
query = "
select origin
     , destination
     , count(gsm) as \"count\"
from bioqc_tissue_migration 
where rk is null or rk = 1 -- in case of multi destination only take the highest enrichment_ratio. 
  and tissue_set = 'bioqc_all'
group by origin, destination
order by origin, destination"
migration = dbGetQuery(mydb, query)
set.seed(42)
col = rand_color(length(unique(migration$ORIGIN)))
chordDiagram(migration, col=col)
```

```{r migration_chart_wo_blood, fig.width=7, fig.height=7}
chordDiagram(migration[migration$ORIGIN != 'blood' & migration$DESTINATION!='blood',])
```

Contamination in total: 
```{r}
byTissue = "
select tissue
     , count(gsm) as total
     , count(is_contam) as total
     , count(is_contam)/cast(count(gsm) as float) as ratio
from bioqc_contam_stats
where tissue_set = 'gtex_solid'
group by tissue
order by ratio desc
"

tissue = data.table(dbGetQuery(mydb, byTissue))
tissue[,TISSUE:=factor(TISSUE, levels=TISSUE)]
ggplot(data=tissue, aes(x=TISSUE, y=RATIO)) +
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

We can also compose statistics about the origin of samples

By time
```{r}
byYear = "
select year
     , tissue
     , count(gsm) as total
     , count(is_contam) as total
     , count(is_contam)/cast(count(gsm) as float) as ratio
from bioqc_contam_stats
group by year, tissue
order by year, tissue 
"

year = dbGetQuery(mydb, byYear)
tissues = c("adipose")
year.2 = year[year$TISSUE %in% tissues,]

ggplot(data=year, aes(x=YEAR, y=RATIO)) + stat_summary(fun.y="mean", geom="bar")
```


By country
(that's nice figures, but it's not very representative... tissue-bias, statistical significance, ...)
```{r}
byCountry = "
select country
     , tissue
     , count(gsm) as total
     , count(is_contam) as total
     , count(is_contam)/cast(count(gsm) as float) as ratio
from bioqc_contam_stats
group by country, tissue
order by country, tissue 
"

country = dbGetQuery(mydb, byCountry)
country.2 = country[country$TISSUE == 'liver',]
#country.2 = ddply(country[country$total > 2000,], ~country,summarise,ratio=mean(ratio))

spdf <- joinCountryData2Map(country.2, joinCode="NAME", nameJoinColumn="COUNTRY")
mapCountryData(spdf, nameColumnToPlot="RATIO", catMethod="fixedWidth")

```

By organism
```{r}
byOrganism = "
select organism
     , tissue
     , count(gsm) as total
     , count(is_contam) as total
     , count(is_contam)/cast(count(gsm) as float) as ratio
from bioqc_contam_stats
group by organism, tissue
order by organism, tissue 
"

organism = dbGetQuery(mydb, byOrganism)
tissues = c("blood", "brain", "kidney", "liver")
organism.2 = organism[organism$TISSUE %in% tissues, ]

#ggplot(data=organism.2, aes(x=ORGANISM, y=RATIO)) + stat_summary(fun.y="mean", geom="bar")
ggplot(data=organism.2, aes(x=ORGANISM, y=RATIO)) + 
  geom_boxplot() +
  geom_point(aes(color=TISSUE))
```

