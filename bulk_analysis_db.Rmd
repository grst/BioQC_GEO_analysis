Analyse GEO Samples for contamination
=====================================

In this file, run BioQC on all samples that have the required metadata
to perform a meaningful contamination analysis: annotated tissue and
annotated gene symbols. 

```{r}
library(BioQC)
library(rworldmap)
source("lib/plots.R")
source("lib/db.R")
```


First, we retrieve a list of the corresponding studies from the database: 
```{r}
gse = dbGetQuery(mydb, "select distinct gse_gsm.gse from gse_gsm
                        join bioqc_gsm bgsm on bgsm.gsm = gse_gsm.gsm
                        join gse_gpl on gse_gpl.gse = gse_gsm.gse
                        join gpl on gpl.gpl = gse_gpl.gpl
                        where bgsm.tissue != 'other' and gpl.bioc_package is not NULL and gpl.bioc_package != '';")
writeLines(gse$gse, file("results/gse_identifiers_bulk_analysis.txt"))
```

We then run BioQC on these studies on the HPC using *chunksub*. The results live 
in `/data64/bi/data/GEO_all/tmp/bioqc/bioqc_annotation_tissue` and have been 
imported into the database using `scripts/bioqc2db.R`. 

To get an overview, we want to replicate the heatmaps for each tissue that we created in `bulk_analysis_gds.Rmd`. 

```{r}
tissues = dbGetQuery(mydb, "select * from bioqc_tissues where id != 'other'")

getTissueSamples = function(tissue, limit=-1) {
  # get all samples belonging to one tissue and filter for siginifant 
  # signatures in one sql query! 
  query = "
  with bioqc_res_filtered as (
      select bioqc_res.*, bioqc_gsm.tissue 
      from bioqc_res
      join bioqc_gsm on bioqc_gsm.gsm = bioqc_res.gsm
      join gsm on gsm.gsm = bioqc_res.gsm
      where tissue = ? and
      organism_ch1 = 'Homo sapiens'
  ),
  gsm_rand as (
      select gsm from (select distinct gsm from bioqc_res_filtered) as gsm_distinct
      %s
  )
  select * from gsm_rand join 
  bioqc_res_filtered on gsm_rand.gsm = bioqc_res_filtered.gsm
  where signature in (
      select distinct signature
      from bioqc_res_filtered   
      where pvalue < 1e-8
  )"
  if(limit > 0) {
    query = sprintf(query, sprintf("order by random() limit %d", limit))
  } else {
    query = sprintf(query, "")
  }
  data = dbGetQuery(mydb, query, tissue)
  data = data.frame(data, pvalue.log=absLog10p(data[,"pvalue"]))
  return(data)
}

for(tissue in tissues$id) {
  data = getTissueSamples(tissue, 300)
  print(tissue)
  hm.palette <- colorRampPalette(rev(brewer.pal(11, 'Spectral')), space='Lab')  
  data$gsm = factor(data$gsm, levels=sample(unique(data$gsm)))  
  the.plot = ggplot(data=data, aes(x=gsm, y=signature, fill=pvalue.log)) + geom_tile() +
    coord_equal() +
    scale_fill_gradientn(colours = hm.palette(100)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle(tissue)
  pdf(file=sprintf("results/heatmaps_db/%s.pdf", tissue), width=100, height=15)
  print(the.plot)
  dev.off()
}
```


Now, detect samples we defined as contamined:
* highly siginificant BioQC scores (min score per sample >6)
* signature outside 'expected' signature that is at least 6 higher than the highest score in expected signatures. 
* (outlier in study)

We can find contamined studies with SQL only. 
To speed up things, we create a temporary table (rather a materialized view, but that's 
not available on our old postgres server) filtering for samples, where a non-expected
signature exceeds all expected signatures by a certain threshold (BioQC score > 6, aka. 'enrichment-ratio'). This table is created in `db/queries/mk-extended_bioqc_res_table2.sql`. 

We create a view `contamined_samples` that contains all contamined samples in `db/queries/get_contamined_samples.sql`. 

Second, we retrieve the information we need for the migration chart from that temporary table. 
```{r} 
query = paste(readLines(file("db/queries/get_migration_chart.sql")), collapse="\n")
migration = dbGetQuery(mydb, query)
chordDiagram(migration)
```

```{r}
chordDiagram(migration[migration$tissue != 'blood' & migration$destination_tissue!='blood',])
```

We can also compose statistics about the origin of samples

By time
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_year as 
  select gsm, (regexp_matches(submission_date, '(\\d{4})-.*'))[1] as year
  from gsm   
")
gsmByYear = " 
select year, count(gsm) from gsm_by_year
group by year
order by year
"
contaminedByYear = "
select year, count(gsm.gsm) from contamined_samples cs 
join gsm_by_year gsm on gsm.gsm = cs.gsm
group by year
order by year
"

year.bg = dbGetQuery(mydb, gsmByYear)
year.cont = dbGetQuery(mydb, contaminedByYear)
year = data.frame(year=year.cont$year, contamined=year.cont$count, all=year.bg[matchColumnIndex(year.cont$year, year.bg, 'year'), 'count'])
year = cbind(year, ratio=year$contamined/year$all)
ggplot(data=year, aes(x=year, y=ratio)) + geom_point()
```


By country
(that's nice figures, but it's not very representative... tissue-bias, statistical significance, ...)
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_country as
  select gsm.gsm, tissue,
  trim(both ' ' from (regexp_matches(contact, '.*Country:(.*?)(;.*)?$'))[1]) as country
  from gsm
  join bioqc_gsm bg on bg.gsm = gsm.gsm
")
gsmByCountry = "
select country, tissue, count(gsm) from gsm_by_country
group by country, tissue
order by country, tissue
"
contaminedByCountry = "
select country, cs.tissue, count(gsm.gsm) from contamined_samples cs
join gsm_by_country gsm on gsm.gsm = cs.gsm
group by country, cs.tissue
order by country, cs.tissue"

country.bg = dbGetQuery(mydb, gsmByCountry)
country.cont = dbGetQuery(mydb, contaminedByCountry)
country = data.frame(country=country.cont$country, contamined=country.cont$count, all=country.bg[matchColumnIndex(country.cont$country, country.bg, 'country'), 'count'])
country = cbind(country, ratio=country$contamined/country$all)

spdf <- joinCountryData2Map(country, joinCode="NAME", nameJoinColumn="country")
mapCountryData(spdf, nameColumnToPlot="ratio", catMethod="fixedWidth")

country.filtered = country[country$all > 10000,]
spdf <- joinCountryData2Map(country.filtered, joinCode="NAME", nameJoinColumn="country")
mapCountryData(spdf, nameColumnToPlot="ratio", catMethod="fixedWidth")
```

