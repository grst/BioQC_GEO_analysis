---
title: Analyse GEO Samples for contamination
output: 
  html_document: default
---

```{r setup, include=FALSE}
source("lib/knitr.R")
library(BioQC)
library(rworldmap)
source("lib/plots.R")
source("lib/db.R")
```


To get an overview, we want to replicate the heatmaps for each tissue that we created in `bulk_analysis_gds.Rmd`. 

```{r, cache=TRUE}
tissues = dbGetQuery(mydb, "select * from bioqc_tissues where id != 'other'")

getTissueSamples = function(tissue, limit=-1) {
  # get all samples belonging to one tissue and filter for siginifant 
  # signatures in one sql query! 
  query = "
  with bioqc_res_filtered as (
      select bioqc_res.*, bioqc_gsm.tissue 
      from bioqc_res
      join bioqc_gsm on bioqc_gsm.gsm = bioqc_res.gsm
      join gsm on gsm.gsm = bioqc_res.gsm
      where tissue = ? and
      organism_ch1 = 'Homo sapiens'
  ),
  gsm_rand as (
      select gsm from (select distinct gsm from bioqc_res_filtered) as gsm_distinct
      %s
  )
  select * from gsm_rand join 
  bioqc_res_filtered on gsm_rand.gsm = bioqc_res_filtered.gsm
  where signature in (
      select distinct signature
      from bioqc_res_filtered   
      where pvalue < 1e-8
  )"
  if(limit > 0) {
    query = sprintf(query, sprintf("order by random() limit %d", limit))
  } else {
    query = sprintf(query, "")
  }
  data = dbGetQuery(mydb, query, tissue)
  data = data.frame(data, pvalue.log=absLog10p(data[,"pvalue"]))
  return(data)
}

for(tissue in tissues$id) {
  data = getTissueSamples(tissue, 300)
  print(tissue)
  hm.palette <- colorRampPalette(rev(brewer.pal(11, 'Spectral')), space='Lab')  
  data$gsm = factor(data$gsm, levels=sample(unique(data$gsm)))  
  the.plot = ggplot(data=data, aes(x=gsm, y=signature, fill=pvalue.log)) + geom_tile() +
    coord_equal() +
    scale_fill_gradientn(colours = hm.palette(100)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle(tissue)
  pdf(file=sprintf("results/heatmaps_db/%s.pdf", tissue), width=100, height=15)
  print(the.plot)
  dev.off()
}
```


Now, detect samples we defined as contamined:
* highly siginificant BioQC scores (min score per sample >6)
* signature outside 'expected' signature that is at least 6 higher than the highest score in expected signatures. 
* (outlier in study)

We can find contamined studies with SQL only. 
To speed up things, we create a temporary table (rather a materialized view, but that's 
not available on our old postgres server) filtering for samples, where a non-expected
signature exceeds all expected signatures by a certain threshold (BioQC score > 6, aka. 'enrichment-ratio'). This table is created in `db/queries/mk-extended_bioqc_res_table2.sql`. 

We create a view `contamined_samples` that contains all contamined samples in `db/queries/get_contamined_samples.sql`. 

Second, we retrieve the information we need for the migration chart from that temporary table. 
```{r} 
query = paste(readLines(file("db/queries/get_migration_chart.sql")), collapse="\n")
migration = dbGetQuery(mydb, query)
chordDiagram(migration)
```

```{r}
chordDiagram(migration[migration$tissue != 'blood' & migration$destination_tissue!='blood',])
```

We can also compose statistics about the origin of samples

By time
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_year as 
  select gsm, (regexp_matches(submission_date, '(\\d{4})-.*'))[1] as year
  from gsm   
")
byYear = "select year, bg.tissue, 
  count(gsm.gsm) as total,
  count(cs.gsm) as contamined, 
  count(cs.gsm)/cast(count(gsm.gsm) as float) as ratio from gsm_by_year gsm
  join bioqc_gsm bg on bg.gsm = gsm.gsm 
  left outer join contamined_samples cs on cs.gsm = gsm.gsm 
  where bg.tissue != 'other'
  group by year, bg.tissue
  order by year, bg.tissue
"

year = dbGetQuery(mydb, byYear)
tissues = c("liver")
year.2 = year[year$tissue %in% tissues,]

ggplot(data=year.2, aes(x=year, y=ratio)) + stat_summary(fun.y="mean", geom="bar")

ggplot(data=year.2, aes(x=year, y=ratio, group=tissue, color=tissue)) + geom_line()
```


By country
(that's nice figures, but it's not very representative... tissue-bias, statistical significance, ...)
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_country as
  select gsm.gsm, trim(both ' ' from (regexp_matches(contact, '.*Country:(.*?)(;.*)?$'))[1]) as country
  from gsm
")
byCountry = "select country, bg.tissue, 
  count(gsm.gsm) as total,
  count(cs.gsm) as contamined, 
  count(cs.gsm)/cast(count(gsm.gsm) as float) as ratio from gsm_by_country gsm
  join bioqc_gsm bg on bg.gsm = gsm.gsm 
  left outer join contamined_samples cs on cs.gsm = gsm.gsm 
  where bg.tissue != 'other'
  group by country, bg.tissue
  order by country, bg.tissue
"

country = dbGetQuery(mydb, byCountry)
country.2 = country[country$tissue == 'brain',]
#country.2 = ddply(country[country$total > 2000,], ~country,summarise,ratio=mean(ratio))

 spdf <- joinCountryData2Map(country.2, joinCode="NAME", nameJoinColumn="country")
mapCountryData(spdf, nameColumnToPlot="ratio", catMethod="fixedWidth")

```

By organism
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_organism as
  select gsm.gsm, organism_ch1 as organism
  from gsm
")
byOrganism = "select organism, bg.tissue, 
  count(gsm.gsm) as total,
  count(cs.gsm) as contamined, 
  count(cs.gsm)/cast(count(gsm.gsm) as float) as ratio from gsm_by_organism gsm
  join bioqc_gsm bg on bg.gsm = gsm.gsm 
  left outer join contamined_samples cs on cs.gsm = gsm.gsm 
  where bg.tissue != 'other'
  and organism in ('Homo sapiens', 'Mus musculus', 'Rattus norvegicus')
  group by organism, bg.tissue
  order by organism, bg.tissue
"

organism = dbGetQuery(mydb, byOrganism)
tissues = c("blood", "brain", "kidney", "liver")
organism.2 = organism[organism$tissue %in% tissues, ]

ggplot(data=organism.2, aes(x=organism, y=ratio)) + stat_summary(fun.y="mean", geom="bar")
ggplot(data=organism.2, aes(x=organism, y=ratio, color=tissue)) + geom_point()
```

