Create and Fill Database
========================================================

create the databaes... 

```{r}
source("lib/db.R")
source("lib/lib.R")
source("lib/geo_annotation.R")
library(RSQLite)
library(testthat)
library(data.table)
```

## Convert GEOMetadb
There is a shell script `db/sqlite_to_psql.sh` that converts the sqlite database into a postgresql database. 

We first need to provide a list of tables: 
```{r}
gdb = dbConnect(SQLite(), "db/geometabase/GEOmetadb.sqlite")
tables = dbListTables(gdb)
writeLines(tables, file("db/geometabase/tables.txt"))
```

Truncate previous data (uncomment corresponding line): 
```{r}
for(table in tables) {
#    dbSendUpdate(mydb, sprintf("truncate %s cascade", tolower(table)))
}
```

```{r}
in.sqlite = dbGetQuery(gdb, "select gsm from gsm order by gsm")
in.psql = dbGetQuery(mydb, "select gsm from gsm order by gsm")
writeLines(in.sqlite[[1]], file("db/in.sqlite.txt"))
writeLines(in.sqlite[[1]], file("db/in.psql.txt"))
```

Then, we run the shell script to import the data.
Now, check for consistency, i.e. do all tables have the same number of rows? 
```{r}
# check for consistency 
for(table in tables) {
  count.query = sprintf("select count(*) from %s", table)
  print(count.query)
  expect_equal(dbGetQuery(gdb, count.query)[[1]], dbGetQuery(mydb, tolower(count.query))[[1]])
}
```

## Tissues
```{r}
dbAppendDf("bioqc_tissues", unique(geo_annotation.tissueMap["tissue"]))
dbSendUpdate(mydb, "insert into bioqc_tissues values('other')")
```

## Signatures
```{r}
library(BioQC)
gmtFile = system.file("extdata/exp.tissuemark.affy.roche.symbols.gmt", package="BioQC")
gmt <- readGmt(gmtFile)
gmt.list = lapply(gmt, function(line) {
  return(list(name=line$name, desc=line$desc, genes=paste(line$genes, collapse=',')))
})
gmt.table = do.call(rbind.data.frame, gmt.table)
dbAppendDf("bioqc_signatures", gmt.table)
```

## Extended sample meta information
The meta information is already provided by GEOmetabase. However, we want to add additional metadata 
in a separate table, e.g extracted tissue annotation. 
```{r}
tissue.raw = dbGetQuery(mydb, "select gsm, characteristics_ch1 from gsm where characteristics_ch1 like '%tissue: %'")
tissues = lapply(lapply(tissue.raw$characteristics_ch1, extractTissue), sanitizeTissue)
table = cbind(gsm=tissue.raw$gsm, tissue=tissues, tissue_orig=tissues.extracted)
dbAppendDf("bioqc_gsm", table)
```

## Load BioQC data into the database
-> separate R script for that. 
