---
title: "Check 'bad' studies"
output: html_notebook
---

```{r setup, include=FALSE}
source("../lib/knitr.R")
source("../lib/config.R")
source("../lib/geo_annotation.R")
```

In the liver heatmap, we identified some studies that expose the same pattern as studies that have been normalised and therefore contain no signal that could be used by BioQC even after filtering out the normalized studies. 

Looking at the metadata, we find no hint, why this could be the case. The purpose of this notebook is to investigate the situation further. 

```{r}
boxplot_eset = function(eset) {
  expr_per_tissue = function(tissue) {
    return(exprs(eset)[fData(eset)$BioqcGeneSymbol %in% gmt_gtex[[tissue]]$genes])
  }
  tissues = names(gmt_gtex)
  expr_df = sapply(tissues, expr_per_tissue)
  ggplot(melt(expr_df), aes(x=L1, y=value)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
}

```

Bad samples, GSE55001
```{r}
load("/pstore/data/biostats/users/sturmg/BioQC_GEO_analysis/gse_tissue_annot/geo_annot/GSE55001.Rdata")
gse55001 = eset_res
boxplot_eset(gse55001)
```


Reprocess that dataset --> looks good! 
```{r}
library(affy)
data = ReadAffy(celfile.path = "/pstore/data/biostats/users/sturmg/BioQC_GEO_analysis/GSE55001_raw")
gse55001_re = rma(data)
gene_symbols = annotateAnyProbeset(rownames(exprs(gse55001_re)), orthologue = T)
gene_symbols$BioqcGeneSymbol = gene_symbols$GeneSymbol
fData(gse55001_re) = gene_symbols
boxplot_eset(gse55001_re)
```
Although, the dataset has been filtered: 

```{r}
gse55001_re_fil = gse55001_re[rownames(exprs(gse55001)),]
gmt = readGmt("../../pygenesig/results/gtex_ngs_0.85_5.gmt")
bioqc_res = wmwTest(gse55001_re_fil, gmt, valType="p.greater", col="BioqcGeneSymbol")
bioqc_res_log = absLog10p(bioqc_res)
boxplot_eset(gse55001_re_fil)
```

Redo filtering, maybe not done correctly 
```{r}
gse55001_re_fil = gse55001_re[apply(exprs(gse55001_re) > log2(100), 1, any),]
gmt = readGmt("../../pygenesig/results/gtex_ngs_0.85_5.gmt")
bioqc_res = wmwTest(gse55001_re_fil, gmt, valType="p.greater", col="BioqcGeneSymbol")
bioqc_res_log = absLog10p(bioqc_res)
boxplot_eset(gse55001_re_fil)
```



# Bad samples, GSE35514
```{r}
load("/pstore/data/biostats/users/sturmg/BioQC_GEO_analysis/gse_tissue_annot/geo_annot/GSE35514.Rdata")
gse35514 = eset_res
boxplot_eset(gse35514)
```



Pancreas contamination, GSE61276
```{r}
load("/pstore/data/biostats/users/sturmg/BioQC_GEO_analysis/gse_tissue_annot/geo_annot/GSE61276.Rdata")
expr_per_tissue = function(tissue) {
  return(exprs(eset_res)[fData(eset_res)$BioqcGeneSymbol %in% gmt_gtex[[tissue]]$genes])
}
tissues = names(gmt_gtex)
expr_df = sapply(tissues, expr_per_tissue)
ggplot(melt(expr_df), aes(x=L1, y=value)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Good samples, GSE55143

```{r}
load("/pstore/data/biostats/users/sturmg/BioQC_GEO_analysis/gse_tissue_annot/geo_annot/GSE55143.Rdata")
expr_per_tissue = function(tissue) {
  return(exprs(eset_res)[fData(eset_res)$BioqcGeneSymbol %in% gmt_gtex[[tissue]]$genes])
}
tissues = names(gmt_gtex)
expr_df = sapply(tissues, expr_per_tissue)
ggplot(melt(expr_df), aes(x=L1, y=value)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
