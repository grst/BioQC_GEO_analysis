---
title: Analyse GEO Samples for contamination
output: 
  html_document: default
---

```{r setup, include=FALSE}
source("lib/knitr.R")
library(BioQC)
library(rworldmap)
source("lib/plots.R")
source("lib/db.R")
```

```
# tissue migration

```

Now, detect samples we defined as contamined:
* highly siginificant BioQC scores (min score per sample >6)
* signature outside 'expected' signature that is at least 6 higher than the highest score in expected signatures. 
* (outlier in study)

We can find contamined studies with SQL only. 
To speed up things, we create a temporary table (rather a materialized view, but that's 
not available on our old postgres server) filtering for samples, where a non-expected
signature exceeds all expected signatures by a certain threshold (BioQC score > 6, aka. 'enrichment-ratio'). This table is created in `db/queries/mk-extended_bioqc_res_table2.sql`. 

We create a view `contamined_samples` that contains all contamined samples in `db/queries/get_contamined_samples.sql`. 

Second, we retrieve the information we need for the migration chart from that temporary table. 
```{r migration_chart, fig.width=7, fig.height=7} 
query = "
select origin
     , destination
     , count(gsm) as \"count\"
from bioqc_tissue_migration 
where rk = 1 -- in case of multi destination only take the highest enrichment_ratio. 
group by origin, destination
order by origin, destination"
migration = dbGetQuery(mydb, query)
chordDiagram(migration)
```

```{r migration_chart_wo_blood, fig.width=7, fig.height=7}
chordDiagram(migration[migration$ORIGIN != 'blood' & migration$DESTINATION!='blood',])
```

We can also compose statistics about the origin of samples

By time
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_year as 
  select gsm, (regexp_matches(submission_date, '(\\d{4})-.*'))[1] as year
  from gsm   
")
byYear = "select year, bg.tissue, 
  count(gsm.gsm) as total,
  count(cs.gsm) as contamined, 
  count(cs.gsm)/cast(count(gsm.gsm) as float) as ratio from gsm_by_year gsm
  join bioqc_gsm bg on bg.gsm = gsm.gsm 
  left outer join contamined_samples cs on cs.gsm = gsm.gsm 
  where bg.tissue != 'other'
  group by year, bg.tissue
  order by year, bg.tissue
"

year = dbGetQuery(mydb, byYear)
tissues = c("liver")
year.2 = year[year$tissue %in% tissues,]

ggplot(data=year.2, aes(x=year, y=ratio)) + stat_summary(fun.y="mean", geom="bar")

ggplot(data=year.2, aes(x=year, y=ratio, group=tissue, color=tissue)) + geom_line()
```


By country
(that's nice figures, but it's not very representative... tissue-bias, statistical significance, ...)
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_country as
  select gsm.gsm, trim(both ' ' from (regexp_matches(contact, '.*Country:(.*?)(;.*)?$'))[1]) as country
  from gsm
")
byCountry = "select country, bg.tissue, 
  count(gsm.gsm) as total,
  count(cs.gsm) as contamined, 
  count(cs.gsm)/cast(count(gsm.gsm) as float) as ratio from gsm_by_country gsm
  join bioqc_gsm bg on bg.gsm = gsm.gsm 
  left outer join contamined_samples cs on cs.gsm = gsm.gsm 
  where bg.tissue != 'other'
  group by country, bg.tissue
  order by country, bg.tissue
"

country = dbGetQuery(mydb, byCountry)
country.2 = country[country$tissue == 'brain',]
#country.2 = ddply(country[country$total > 2000,], ~country,summarise,ratio=mean(ratio))

 spdf <- joinCountryData2Map(country.2, joinCode="NAME", nameJoinColumn="country")
mapCountryData(spdf, nameColumnToPlot="ratio", catMethod="fixedWidth")

```

By organism
```{r}
dbSendUpdate(mydb, "create or replace temp view gsm_by_organism as
  select gsm.gsm, organism_ch1 as organism
  from gsm
")
byOrganism = "select organism, bg.tissue, 
  count(gsm.gsm) as total,
  count(cs.gsm) as contamined, 
  count(cs.gsm)/cast(count(gsm.gsm) as float) as ratio from gsm_by_organism gsm
  join bioqc_gsm bg on bg.gsm = gsm.gsm 
  left outer join contamined_samples cs on cs.gsm = gsm.gsm 
  where bg.tissue != 'other'
  and organism in ('Homo sapiens', 'Mus musculus', 'Rattus norvegicus')
  group by organism, bg.tissue
  order by organism, bg.tissue
"

organism = dbGetQuery(mydb, byOrganism)
tissues = c("blood", "brain", "kidney", "liver")
organism.2 = organism[organism$tissue %in% tissues, ]

ggplot(data=organism.2, aes(x=organism, y=ratio)) + stat_summary(fun.y="mean", geom="bar")
ggplot(data=organism.2, aes(x=organism, y=ratio, color=tissue)) + geom_point()
```

